# CVM Builder (non-CC version)

## Overview
The `cvm_build.sh` script is used to build a Confidential Virtual Machine (CVM) image for NVFlare. It creates a customized QCOW2 image based on a base image for each site based on the
site configuration YAML file.

## Prerequisites

1. **Software Requirements**:
   - Ansible installed (`sudo apt-get install ansible` or equivalent)
   - `xxd` command-line tool (usually comes with vim-common)
   - QEMU tools (for QCOW2 image handling)

2. **Required Base Images**:
   - `nvidia_cc_base.qcow2` in `base_images` directory
   - `applog_base.qcow2` in `base_images` directory

   Those images are stored in `/shared/base_images` folder on the Colossus machine.


## Usage
```bash
./cvm_build.sh <yaml_config> <site_name> <startup_folder>
```

For example, 

```bash
./cvm_build.sh site_1_cc.yml site-1 /tmp/nvflare/poc/example_project/prod_00/site-1
```


### Parameters
1. `yaml_config`: Path to the YAML configuration file
   - This file should contain the site-specific configuration and it's the same file
     used in provisioning.


2. `site_name`: Name of the site/client for the CVM

3. `startup_folder`: Path to the startup folder, generated by provisioning

### Example
```bash
cd nvflare/lighter/cc/image_builder
./cvm_build.sh site_1_cc.yml site-1 /tmp/nvflare/poc/example_project/prod_00/site-1
```

## Result
The script creates two QCOW2 images in the `target` directory:
- `{CVM_ID}_{site_name}_cvm.qcow2`: Main CVM image
- `{CVM_ID}_{site_name}_applog.qcow2`: Applog image

For examples,

```
3d439cba26ac_site-1_applog.qcow2
3d439cba26ac_site-1_cvm.qcow2

```