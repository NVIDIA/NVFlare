RESOURCE_GROUP=nvflare_rg
VM_NAME=nvflare_server
VM_IMAGE=Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest
VM_SIZE=Standard_B2ms
NSG_NAME=nvflare_nsgs
ADMIN_USERNAME=nvflare
PASSWORD="NVFl@r3_P@88"$RANDOM"w0rd"
DEST_FOLDER=/var/tmp/cloud
NIC_NAME=${VM_NAME}VMNic
SERVER_NAME={{ server_name }}
FL_PORT=8002
ADMIN_PORT=8003

echo "This script requires az (Azure CLI), sshpass and jq.  Now checking if they are installed."

check_binary az "Please see https://learn.microsoft.com/en-us/cli/azure/install-azure-cli on how to install it on your system."
check_binary sshpass "Please install it first."
check_binary jq "Please install it first."

self_dns=true
if [[ "$SERVER_NAME" = *".cloudapp.azure.com"* ]]
then
  DNS_TAG=$(echo $SERVER_NAME | cut -d "." -f 1)
  DERIVED_LOCATION=$(echo $SERVER_NAME | cut -d "." -f 2)
  LOCATION=$DERIVED_LOCATION
  self_dns=false
else
  echo "Warning: ${SERVER_NAME} does not end with .cloudapp.azure.com."
  echo "The cloud launch process will not create the domain name for you."
  echo "Please use your own DNS to set the information."
  LOCATION=westus2
fi

if [ -z ${image_name+x} ]
then
    container=false
else
    container=true
fi

if [ $container == true ]
then
  VM_IMAGE=Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest
  VM_SIZE=Standard_D8s_v3
else
  VM_IMAGE=Canonical:0001-com-ubuntu-server-jammy:22_04-lts-gen2:latest
  VM_SIZE=Standard_B2ms
fi

if [ -z ${config_file+x} ]
then
  useDefault=true
else
  useDefault=false
  . $config_file
  report_status "$?" "Loading config file"
  if [ $self_dns == false ] && [ $DERIVED_LOCATION != $LOCATION ]
  then
    echo "Server name implies LOCATION=${DERIVED_LOCATION} but the config file specifies LOCATION=${LOCATION}.  Unable to continue provisioning."
    exit 1
  fi
fi

if [ $useDefault == true ]
then
  while true
  do
    prompt VM_IMAGE "Cloud VM image, press ENTER to accept default" "${VM_IMAGE}"
    prompt VM_SIZE "Cloud VM size, press ENTER to accept default" "${VM_SIZE}"
    if [ $self_dns == true ]
    then
      prompt LOCATION "Cloud location, press ENTER to accept default" "${LOCATION}"
      prompt ans "VM image = ${VM_IMAGE}, VM size = ${VM_SIZE}, location = ${LOCATION}, OK? (Y/n)"
    else
      prompt ans "VM image = ${VM_IMAGE}, VM size = ${VM_SIZE}, OK? (Y/n)"
    fi
    if [[ $ans = "" ]] || [[ $ans =~ ^(y|Y)$ ]]; then break; fi
  done
fi

if [ $container == false ]
then
  echo "If the client requires additional dependencies, please copy the requirements.txt to ${DIR}."
  prompt ans "Press ENTER when it's done or no additional dependencies."
fi

az login --use-device-code -o none
report_status "$?" "login"

# Start provisioning

if [ $(az group exists -n $RESOURCE_GROUP) == 'false' ]
then
  echo "Creating Resource Group $RESOURCE_GROUP at Location $LOCATION"
  az group create --output none --name $RESOURCE_GROUP --location $LOCATION
  report_status "$?" "creating resource group"
elif [ $useDefault == true ]
then
  report_status "1" "Only one NVFL server VM and its resource group is allowed.  $RESOURCE_GROUP exists and thus creating duplicate resource group"
else
  echo "Users require to reuse Resource Group $RESOURCE_GROUP.  This script will modify the group and may not work always."
fi

echo "Creating Virtual Machine, will take a few minutes"
if [ $self_dns == true ]
then
  az vm create \
    --output json \
    --resource-group $RESOURCE_GROUP \
    --location $LOCATION \
    --name $VM_NAME \
    --image $VM_IMAGE \
    --size $VM_SIZE \
    --admin-username $ADMIN_USERNAME \
    --admin-password $PASSWORD \
    --authentication-type password \
    --public-ip-address nvflare_server_ip \
    --public-ip-address-allocation static \
    --public-ip-sku Standard > /tmp/vm.json
else
  az vm create \
    --output json \
    --resource-group $RESOURCE_GROUP \
    --location $LOCATION \
    --name $VM_NAME \
    --image $VM_IMAGE \
    --size $VM_SIZE \
    --admin-username $ADMIN_USERNAME \
    --admin-password $PASSWORD \
    --authentication-type password \
    --public-ip-address nvflare_server_ip \
    --public-ip-address-allocation static \
    --public-ip-sku Standard \
    --public-ip-address-dns-name $DNS_TAG > /tmp/vm.json
fi
report_status "$?" "creating virtual machine"

IP_ADDRESS=$(jq -r .publicIpAddress /tmp/vm.json)
echo "Setting up network related configuration"
az network nsg create \
  --output none \
  --resource-group $RESOURCE_GROUP \
  --location $LOCATION \
  --name $NSG_NAME
report_status "$?" "creating network security group"

az network nsg rule create \
  --output none \
  --resource-group $RESOURCE_GROUP \
  --name SSH \
  --nsg-name $NSG_NAME \
  --priority 1000 \
  --protocol Tcp \
  --destination-port-ranges 22
report_status "$?" "creating network security group rule for SSH"

az network nsg rule create \
  --output none \
  --resource-group $RESOURCE_GROUP \
  --name FL_PORT \
  --nsg-name $NSG_NAME \
  --priority 1001 \
  --protocol Tcp \
  --destination-port-ranges $FL_PORT
report_status "$?" "creating network security group rule for FL port"

az network nsg rule create \
  --output none \
  --resource-group $RESOURCE_GROUP \
  --name ADMIN_PORT \
  --nsg-name $NSG_NAME \
  --priority 1002 \
  --protocol Tcp \
  --destination-port-ranges $ADMIN_PORT
report_status "$?" "creating network security group rule for Admin port"
