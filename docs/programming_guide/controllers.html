<!--
# Copyright (c) 2020, NVIDIA CORPORATION. All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#  * Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
#  * Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#  * Neither the name of NVIDIA CORPORATION nor the names of its
#    contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY
# EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
# OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Controllers and Controller API &mdash; NVIDIA FLARE 2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/additions.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Filters" href="filters.html" />
    <link rel="prev" title="FLComponent" href="fl_component.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
           

          
            <a href="../index.html" class="icon icon-home"> NVIDIA FLARE
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 80%;
    }

    .floatleftcol {
      float: left;
      max-width: 60%;
      padding-right: 20px;
    }
  </style>
  
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User Guide - Provision, Start, Operate</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../programming_guide.html">Programming Guide - Developing Apps with NVIDIA FLARE</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="fl_context.html">FLContext</a></li>
<li class="toctree-l2"><a class="reference internal" href="fl_component.html">FLComponent</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Controllers and Controller API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#controller-worker-interactions">Controller/Worker Interactions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#controller-api">Controller API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#scatter-and-gather-workflow">Scatter and Gather Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#trainer">Trainer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#learnable">Learnable</a></li>
<li class="toctree-l3"><a class="reference internal" href="#aggregator">Aggregator</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#cross-site-model-evaluation-federated-evaluation">Cross Site Model Evaluation / Federated Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cyclic-workflow">Cyclic Workflow</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#task-lifecycle">Task Lifecycle</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="filters.html">Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="executor.html">Executors</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_system.html">NVIDIA FLARE Event Mechanism</a></li>
<li class="toctree-l2"><a class="reference internal" href="shareable.html">Shareable</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_exchange_object.html">Data Exchange Object (DXO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="best_practices.html">NVIDIA FLARE Programming Best Practices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apidocs/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NVIDIA FLARE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../programming_guide.html">Programming Guide - Developing Apps with NVIDIA FLARE</a> &raquo;</li>
        
      <li>Controllers and Controller API</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/programming_guide/controllers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="controllers-and-controller-api">
<span id="id1"></span><h1>Controllers and Controller API<a class="headerlink" href="#controllers-and-controller-api" title="Permalink to this headline">¶</a></h1>
<div class="section" id="controller-worker-interactions">
<h2>Controller/Worker Interactions<a class="headerlink" href="#controller-worker-interactions" title="Permalink to this headline">¶</a></h2>
<p>NVIDIA FLARE 2.0’s collaborative computing is achieved through the Controller/Worker interactions.</p>
<img alt="../_images/Controller_worker.png" src="../_images/Controller_worker.png" style="height: 300px;" />
<p>The Controller is a python object that controls or coordinates the Workers to get a job done. The controller is run on
the FL server (highlighted on the right).</p>
<img alt="../_images/Controller.png" src="../_images/Controller.png" style="height: 300px;" />
<p>A Worker is capable of performing tasks. Workers run on FL clients.</p>
<p>In its control logic, the Controller assigns tasks to Workers and processes task results from the Workers.</p>
<p>Workers keep asking for the next task to do, executes the task, and submits results to the Controller, until instructed
to exit by the Controller (a special END_RUN task).</p>
<p>The following diagram depicts how the Controller and Worker interact.</p>
</div>
<div class="section" id="controller-api">
<h2>Controller API<a class="headerlink" href="#controller-api" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../apidocs/nvflare.apis.html#module-nvflare.apis.controller_spec" title="nvflare.apis.controller_spec"><code class="xref py py-mod docutils literal notranslate"><span class="pre">Controller</span> <span class="pre">API</span></code></a> provides methods for assigning tasks to the Workers (FL clients)
in different ways:</p>
<blockquote>
<div><ul class="simple">
<li><p>Broadcast a task to multiple clients</p></li>
<li><p>Send a task to a single client</p></li>
<li><p>Arrange a task to be done by multiple clients in turns</p></li>
</ul>
</div></blockquote>
<p>See the included <a class="reference internal" href="../apidocs/nvflare.apis.impl.html#nvflare.apis.impl.controller.Controller" title="nvflare.apis.impl.controller.Controller"><code class="xref py py-class docutils literal notranslate"><span class="pre">Controller</span></code></a> implementation and full reference
implementations of the following controller workflows: <a class="reference internal" href="controllers/scatter_and_gather_workflow.html#scatter-and-gather-workflow"><span class="std std-ref">Scatter and Gather Workflow</span></a>, <a class="reference internal" href="controllers/cross_site_model_evaluation.html#cross-site-model-evaluation"><span class="std std-ref">Cross Site Model Evaluation / Federated Evaluation</span></a>, and
<span class="xref std std-ref">cyclic_workflow</span>.</p>
</div>
</div>
<div class="section" id="scatter-and-gather-workflow">
<span id="id2"></span><h1>Scatter and Gather Workflow<a class="headerlink" href="#scatter-and-gather-workflow" title="Permalink to this headline">¶</a></h1>
<p>The Federated scatter and gather workflow is an included reference implementation of the default workflow of previous versions
of NVIDIA FLARE with a Server aggregating results from Clients that have produced Shareable results from their Trainer.</p>
<p>At the core, the control_flow of <a class="reference internal" href="../apidocs/nvflare.app_common.workflows.html#nvflare.app_common.workflows.scatter_and_gather.ScatterAndGather" title="nvflare.app_common.workflows.scatter_and_gather.ScatterAndGather"><code class="xref py py-class docutils literal notranslate"><span class="pre">nvflare.app_common.workflows.scatter_and_gather.ScatterAndGather</span></code></a> is a for loop:</p>
<img alt="programming_guide/resources/fed_sag_round.png" src="programming_guide/resources/fed_sag_round.png" style="height: 400px;" />
<div class="section" id="trainer">
<h2>Trainer<a class="headerlink" href="#trainer" title="Permalink to this headline">¶</a></h2>
<p>You need to implement the <code class="docutils literal notranslate"><span class="pre">train()</span></code> method for your <code class="xref py py-class docutils literal notranslate"><span class="pre">Trainer</span></code>.</p>
<p>FL client gets the global <code class="docutils literal notranslate"><span class="pre">Shareable</span></code> from the FL server for each round and then the <code class="docutils literal notranslate"><span class="pre">train()</span></code> method will be called.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">train()</span></code> method needs to get the required information from the global <code class="docutils literal notranslate"><span class="pre">Shareable</span></code>,
use that in its training process, then returning the local training result as a <code class="docutils literal notranslate"><span class="pre">Shareable</span></code>.</p>
<p>You will need to configure your own <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> in config_fed_client.json.
Example FL configurations can be found in <a class="reference internal" href="../user_guide/application.html#application"><span class="std std-ref">NVIDIA FLARE Application</span></a>.</p>
</div>
<div class="section" id="learnable">
<h2>Learnable<a class="headerlink" href="#learnable" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../apidocs/nvflare.app_common.abstract.html#nvflare.app_common.abstract.learnable.Learnable" title="nvflare.app_common.abstract.learnable.Learnable"><code class="xref py py-class docutils literal notranslate"><span class="pre">Learnable</span></code></a> is the result of an FL application.
For example, in the deep learning scenario, it can be the model weights.
In the AutoML case, it can be the network architecture.</p>
<p>A <a class="reference internal" href="../apidocs/nvflare.app_common.abstract.html#nvflare.app_common.abstract.learnable_persistor.LearnablePersistor" title="nvflare.app_common.abstract.learnable_persistor.LearnablePersistor"><code class="xref py py-class docutils literal notranslate"><span class="pre">LearnablePersistor</span></code></a> defines how to load
and save a <code class="docutils literal notranslate"><span class="pre">Learnable</span></code>. <code class="docutils literal notranslate"><span class="pre">Learnable</span></code> is a subset of the model file (which can contain other data like LR schedule)
which is to be learned, like the model weights.</p>
</div>
<div class="section" id="aggregator">
<h2>Aggregator<a class="headerlink" href="#aggregator" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../apidocs/nvflare.app_common.abstract.html#nvflare.app_common.abstract.aggregator.Aggregator" title="nvflare.app_common.abstract.aggregator.Aggregator"><code class="xref py py-class docutils literal notranslate"><span class="pre">Aggregators</span></code></a> define the aggregation algorithm to aggregate the <code class="docutils literal notranslate"><span class="pre">Shareable</span></code>.
For example, a simple aggregator would be just average all the <code class="docutils literal notranslate"><span class="pre">Shareable</span></code> of the same round.</p>
<p>Below is the signature for an aggregator.</p>
</div>
</div>
<div class="section" id="cross-site-model-evaluation-federated-evaluation">
<span id="cross-site-model-evaluation"></span><h1>Cross Site Model Evaluation / Federated Evaluation<a class="headerlink" href="#cross-site-model-evaluation-federated-evaluation" title="Permalink to this headline">¶</a></h1>
<p>The cross site model evaluation workflow uses the data from clients to run evaluation with the models of other clients.</p>
<p><a class="reference internal" href="../apidocs/nvflare.app_common.workflows.html#nvflare.app_common.workflows.cross_site_model_eval.CrossSiteModelEval" title="nvflare.app_common.workflows.cross_site_model_eval.CrossSiteModelEval"><code class="xref py py-class docutils literal notranslate"><span class="pre">nvflare.app_common.workflows.cross_site_model_eval.CrossSiteModelEval</span></code></a></p>
</div>
<div class="section" id="cyclic-workflow">
<h1>Cyclic Workflow<a class="headerlink" href="#cyclic-workflow" title="Permalink to this headline">¶</a></h1>
<p>Cyclic workflow is new for NVIDIA FLARE 2.0.</p>
<p><a class="reference internal" href="../apidocs/nvflare.app_common.workflows.html#nvflare.app_common.workflows.cyclic_ctl.CyclicController" title="nvflare.app_common.workflows.cyclic_ctl.CyclicController"><code class="xref py py-class docutils literal notranslate"><span class="pre">nvflare.app_common.workflows.cyclic_ctl.CyclicController</span></code></a></p>
<p>You can study the source code and use it as a starting point to write your own controller workflows.</p>
<div class="section" id="task-lifecycle">
<h2>Task Lifecycle<a class="headerlink" href="#task-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>The central concept of the Controller API is <a class="reference internal" href="../apidocs/nvflare.apis.html#nvflare.apis.controller_spec.Task" title="nvflare.apis.controller_spec.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a>.</p>
<p>A <a class="reference internal" href="../apidocs/nvflare.apis.html#nvflare.apis.controller_spec.Task" title="nvflare.apis.controller_spec.Task"><code class="xref py py-class docutils literal notranslate"><span class="pre">Task</span></code></a> is a piece of work that is assigned by the Controller to client workers. Depending on how the task is assigned (broadcast, send, or relay), the task will be performed by one or more clients.</p>
<p>The Controller’s Task Manager manages the task’s lifecycle:</p>
<blockquote>
<div><ul class="simple">
<li><p>First, the programmer creates the task, specifying the name and the data of the task.</p></li>
<li><p>Then, the programmer calls one of the task methods (e.g. broadcast, send, relay, etc.). All these methods do is simply adding the task to the Task Queue. Now the task is waiting for clients to come to retrieve it. Note that there could be multiple tasks in the queue.</p></li>
<li><p>When a client comes to get the next task, the Task Manager decides which task in the queue should be assigned to the client. The general rule is that the tasks will be examined one by one following their orders in the queue. If the client is a candidate of the task and the task has not been performed by the client, AND the task-specific rule allows the client to be assigned, then the task is assigned to the client, and a new ClientTask record is created and added to the task’s client_tasks list. If the before_task_sent callback (CB) is provided, it is called before sending the task to the client.</p></li>
<li><p>If no task is found for the client, the Task Manager tells the client to try again later.</p></li>
<li><p>When the client finishes its assigned task and comes back to submit its result, the client_task is found for this client, and then the result_received CB (if provided) is called. The result is recorded into the client_task record, and the client_task is marked as “result received”.</p></li>
<li><dl class="simple">
<dt>Eventually the task is completed when one of the following conditions is met:</dt><dd><ul>
<li><p>The task itself is timed out (if the task timeout is specified)</p></li>
<li><p>All assigned tasks received results from clients</p></li>
<li><p>Task specific exit rule is met (e.g. for broadcast, the minimal-responses are received and waited for enough time after that)</p></li>
<li><p>The task is cancelled explicitly</p></li>
<li><p>Fatal error occurred (task data filtering error) and the task is cancelled by the system</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Once the task is completed, it’s completion_status is set based on the condition the task is completed, and the task is removed from the task queue. If the task_done CB is provided, it is called. This is the end of the task’s lifecycle.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In NVIDIA FLARE 2.0, the underlying communication is by gRPC: the client always initiates communication by sending
a request to the server and a receiving response. When we say “server sends task to the client”, it is only
conceptual. With gRPC, the client sends the “ask for next task” request to the server, and the server responds with
the task data.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="filters.html" class="btn btn-neutral float-right" title="Filters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="fl_component.html" class="btn btn-neutral float-left" title="FLComponent" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, NVIDIA.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  p {
    margin-bottom: 1em;
  }

  .rst-content dl dt {
    font-weight: unset;
    margin-bottom: 0;
  }

  .rst-content .section ul p {
    margin-bottom: 0px;
  }
  </style>
  

</body>
</html>