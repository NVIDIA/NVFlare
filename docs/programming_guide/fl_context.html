<!--
# Copyright (c) 2020, NVIDIA CORPORATION. All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
#  * Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
#  * Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#  * Neither the name of NVIDIA CORPORATION nor the names of its
#    contributors may be used to endorse or promote products derived
#    from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY
# EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
# OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
# (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>FLContext &mdash; NVIDIA FLARE 2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/additions.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Filters" href="filters.html" />
    <link rel="prev" title="NVIDIA FLARE Event Mechanism" href="event_system.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
           

          
            <a href="../index.html" class="icon icon-home"> NVIDIA FLARE
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 80%;
    }

    .floatleftcol {
      float: left;
      max-width: 60%;
      padding-right: 20px;
    }
  </style>
  
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../highlights.html">NVIDIA FLARE Key Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide.html">User Guide - Provision, Start, Operate</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../programming_guide.html">Programming Guide - Developing Apps with NVIDIA FLARE</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="controllers.html">Controllers and Controller API</a></li>
<li class="toctree-l2"><a class="reference internal" href="executor.html">Executors</a></li>
<li class="toctree-l2"><a class="reference internal" href="event_system.html">NVIDIA FLARE Event Mechanism</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">FLContext</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#visibility">Visibility</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stickiness">Stickiness</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-props-in-flcontext">Accessing Props in FLContext</a></li>
<li class="toctree-l3"><a class="reference internal" href="#permanent-props-in-fl-contexts">Permanent Props in FL Contexts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#engine-fl-ctx-get-engine">Engine (fl_ctx.get_engine())</a></li>
<li class="toctree-l4"><a class="reference internal" href="#run-number-fl-ctx-get-run-number">Run Number (fl_ctx.get_run_number())</a></li>
<li class="toctree-l4"><a class="reference internal" href="#identity-name-fl-ctx-get-identity-name">Identity Name (fl_ctx.get_identity_name())</a></li>
<li class="toctree-l4"><a class="reference internal" href="#peer-context-fl-ctx-get-peer-context">Peer Context (fl_ctx.get_peer_context())</a></li>
<li class="toctree-l4"><a class="reference internal" href="#app-root-fl-ctx-get-prop-flcontextkey-app-root">App Root (fl_ctx.get_prop(FLContextKey.APP_ROOT))</a></li>
<li class="toctree-l4"><a class="reference internal" href="#runtime-args-fl-ctx-get-prop-flcontextkey-args">Runtime args (fl_ctx.get_prop(FLContextKey.ARGS))</a></li>
<li class="toctree-l4"><a class="reference internal" href="#workspace-root-fl-ctx-get-prop-flcontextkey-workspace-root">Workspace Root (fl_ctx.get_prop(FLContextKey.WORKSPACE_ROOT))</a></li>
<li class="toctree-l4"><a class="reference internal" href="#workspace-object-fl-ctx-get-prop-flcontextkey-workspace-object">Workspace Object (fl_ctx.get_prop(FLContextKey.WORKSPACE_OBJECT))</a></li>
<li class="toctree-l4"><a class="reference internal" href="#secure-mode-fl-ctx-get-prop-flcontextkey-secure-mode-true">Secure Mode (fl_ctx.get_prop(FLContextKey.SECURE_MODE, True))</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#fl-context-lifecycle">FL Context Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-available-in-the-shared-flcontext">Data available in the shared FLContext</a></li>
<li class="toctree-l3"><a class="reference internal" href="#client-side-fl-context">Client Side FL Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#server-side-fl-context">Server Side FL Context</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#task-request-processing">Task Request Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-result-processing">Task Result Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-done-processing">Task Done Processing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controller-s-control-flow">Controller’s Control Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#peer-context">Peer Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-ad-hoc-fl-context">Create ad-hoc FL Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-specification">API Specification</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#property-access">Property access</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="filters.html">Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="shareable.html">Shareable</a></li>
<li class="toctree-l2"><a class="reference internal" href="data_exchange_object.html">Data Exchange Object (DXO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="fl_component.html">FLComponent</a></li>
<li class="toctree-l2"><a class="reference internal" href="best_practices.html">NVIDIA FLARE Programming Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../programming_guide.html#code-structure">Code Structure</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apidocs/modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix.html">Appendix</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">NVIDIA FLARE</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../programming_guide.html">Programming Guide - Developing Apps with NVIDIA FLARE</a> &raquo;</li>
        
      <li>FLContext</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/programming_guide/fl_context.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="flcontext">
<span id="fl-context"></span><h1>FLContext<a class="headerlink" href="#flcontext" title="Permalink to this headline">¶</a></h1>
<p>One of the most important features of NVIDIA FLARE is <a class="reference internal" href="../apidocs/nvflare.apis.html#module-nvflare.apis.fl_context" title="nvflare.apis.fl_context"><code class="xref py py-mod docutils literal notranslate"><span class="pre">nvflare.apis.fl_context</span></code></a> to pass data between the FL
components. <code class="docutils literal notranslate"><span class="pre">FLContext</span></code> is available to every method of all FLComponent types (Controller, Aggregator, Filter,
Executor, Widget).</p>
<dl class="simple">
<dt>Through the FL Context, the component developer can:</dt><dd><ul class="simple">
<li><p>Get services provided by the underlying infrastructure</p></li>
<li><p>Share data with other components of the FL system, even including components in the peer endpoints (between
server and clients)</p></li>
</ul>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">FLContext</span></code> can be thought of as a Python dictionary that stores key/value pairs. Data items stored in <code class="docutils literal notranslate"><span class="pre">FLContext</span></code>
are called properties, or props for short. Props have two attributes: visibility and stickiness.</p>
<div class="section" id="visibility">
<h2>Visibility<a class="headerlink" href="#visibility" title="Permalink to this headline">¶</a></h2>
<p>Determines whether the prop is only visible to local components that reside in the same process or remote components
that reside in the peer endpoint:</p>
<blockquote>
<div><ul class="simple">
<li><p>Props only visible to local components are <em>private</em></p></li>
<li><p>Props that are also visible to remote components are <em>public</em>.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="stickiness">
<h2>Stickiness<a class="headerlink" href="#stickiness" title="Permalink to this headline">¶</a></h2>
<p>Determines whether the prop is only to be scoped in the current FL Context or if it is to be made
available to all future FL Contexts:</p>
<blockquote>
<div><ul class="simple">
<li><p>Props that will become available in all future FL Contexts are <em>sticky</em>. This is useful to share objects dynamically created by a component to other components.</p></li>
<li><p>Props that are only to be scoped in the current FL Context are <em>non-sticky</em>.</p></li>
</ul>
</div></blockquote>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>Since public props will be shared with peer endpoints, be very careful about them - they must not be sensitive to
privacy! Also since the prop will be sent to the peers through messages, the prop must be serializable.</p>
</div>
</div>
<div class="section" id="accessing-props-in-flcontext">
<h2>Accessing Props in FLContext<a class="headerlink" href="#accessing-props-in-flcontext" title="Permalink to this headline">¶</a></h2>
<p>To set a prop into the FL Context, use the <a class="reference internal" href="../apidocs/nvflare.apis.html#nvflare.apis.fl_context.FLContext.set_prop" title="nvflare.apis.fl_context.FLContext.set_prop"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_prop()</span></code></a> method of FLContext:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>If the prop already exists in the context, its value is updated with the new value.
If the prop is not in the context, it is added to the context.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All props have unique names, which must be strings. Once a prop is placed into the FL Context, its attributes can
never be changed.</p>
</div>
<p>To retrieve a prop, use the get_prop() method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>To remove a prop from the FL Context, use remove_prop() method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">remove_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The prop is only removed from the FL Context the remove_prop method is called on.</p>
</div>
<p>There are many other useful methods for FL Context. Please see fl_context.py for detail.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Prop names must be strings. Stay away from prop names starting with double underscores “__”. These are reserved for
the framework. You cannot remove such props from FL context.</p>
</div>
</div>
<div class="section" id="permanent-props-in-fl-contexts">
<h2>Permanent Props in FL Contexts<a class="headerlink" href="#permanent-props-in-fl-contexts" title="Permalink to this headline">¶</a></h2>
<p>Some props are always added to the FL Context by the framework.</p>
<div class="section" id="engine-fl-ctx-get-engine">
<h3>Engine (fl_ctx.get_engine())<a class="headerlink" href="#engine-fl-ctx-get-engine" title="Permalink to this headline">¶</a></h3>
<p>The engine represents the underlying services that can be used by the application. See ServerEngineSpec and/or
ClientEngineSpec for services they provide.</p>
</div>
<div class="section" id="run-number-fl-ctx-get-run-number">
<h3>Run Number (fl_ctx.get_run_number())<a class="headerlink" href="#run-number-fl-ctx-get-run-number" title="Permalink to this headline">¶</a></h3>
<p>FL application is always running within a RUN, which has a unique ID number.</p>
</div>
<div class="section" id="identity-name-fl-ctx-get-identity-name">
<h3>Identity Name (fl_ctx.get_identity_name())<a class="headerlink" href="#identity-name-fl-ctx-get-identity-name" title="Permalink to this headline">¶</a></h3>
<p>Each running endpoint has a unique identity name. You can get the identity name of the endpoint your application is
running in.</p>
</div>
<div class="section" id="peer-context-fl-ctx-get-peer-context">
<h3>Peer Context (fl_ctx.get_peer_context())<a class="headerlink" href="#peer-context-fl-ctx-get-peer-context" title="Permalink to this headline">¶</a></h3>
<p>When processing a message from the peer, the FLContext object passed to your callback functions contains the Peer
Context, which contains the public props from the peer endpoint. Note that not all FL Contexts have peer contexts -
only those passed to your callback functions (before_task_sent, after_task_sent, and result_received on the Server
side, and the executor’s execute() method on the Client side) have peer contexts. Since filters are invoked to process
data between the peers, the FLContext passed to filters also contains a peer context.</p>
</div>
<div class="section" id="app-root-fl-ctx-get-prop-flcontextkey-app-root">
<h3>App Root (fl_ctx.get_prop(FLContextKey.APP_ROOT))<a class="headerlink" href="#app-root-fl-ctx-get-prop-flcontextkey-app-root" title="Permalink to this headline">¶</a></h3>
<p>The name of the current RUN’s app folder.</p>
</div>
<div class="section" id="runtime-args-fl-ctx-get-prop-flcontextkey-args">
<h3>Runtime args (fl_ctx.get_prop(FLContextKey.ARGS))<a class="headerlink" href="#runtime-args-fl-ctx-get-prop-flcontextkey-args" title="Permalink to this headline">¶</a></h3>
<p>Runtime args used to start the server/client process. This is a dict.</p>
</div>
<div class="section" id="workspace-root-fl-ctx-get-prop-flcontextkey-workspace-root">
<h3>Workspace Root (fl_ctx.get_prop(FLContextKey.WORKSPACE_ROOT))<a class="headerlink" href="#workspace-root-fl-ctx-get-prop-flcontextkey-workspace-root" title="Permalink to this headline">¶</a></h3>
<p>The name of the workspace root folder.</p>
</div>
<div class="section" id="workspace-object-fl-ctx-get-prop-flcontextkey-workspace-object">
<h3>Workspace Object (fl_ctx.get_prop(FLContextKey.WORKSPACE_OBJECT))<a class="headerlink" href="#workspace-object-fl-ctx-get-prop-flcontextkey-workspace-object" title="Permalink to this headline">¶</a></h3>
<p>The workspace object (of <a class="reference internal" href="../apidocs/nvflare.apis.html#nvflare.apis.workspace.Workspace" title="nvflare.apis.workspace.Workspace"><code class="xref py py-class docutils literal notranslate"><span class="pre">nvflare.apis.workspace.Workspace</span></code></a> type).</p>
</div>
<div class="section" id="secure-mode-fl-ctx-get-prop-flcontextkey-secure-mode-true">
<h3>Secure Mode (fl_ctx.get_prop(FLContextKey.SECURE_MODE, True))<a class="headerlink" href="#secure-mode-fl-ctx-get-prop-flcontextkey-secure-mode-true" title="Permalink to this headline">¶</a></h3>
<p>Whether NVIDIA FLARE is running in secure mode or not.</p>
</div>
</div>
<div class="section" id="fl-context-lifecycle">
<h2>FL Context Lifecycle<a class="headerlink" href="#fl-context-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>The NVIDIA FLARE system is a multi-threaded messaging environment. A new FLContext instance is created when processing a new
message (in the messaging thread). At any time, there could be multiple instances of FL Contexts.</p>
<p>The following is the general lifecycle of a FL Context:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Created</strong>: Never create a new FL Context directly with FLContext()! Always call engine.new_context(). Engine
creates a new FL Context with the FL Context Manager <code class="xref py py-class docutils literal notranslate"><span class="pre">nvflare.api.fl_context.FLContext</span></code> (FLCM) associated with the engine. The FLCM keeps the
permanent props and all sticky props created by components. When creating a new FL Context, the FLCM copies
these props to the created FL Context.</p></li>
<li><p><strong>Used</strong>: The FL Context is used by system and/or application logic - props are read and placed into the context.
The FL Context is usually passed to multiple components, and these components can share data thru the FL context
passed thru them (one component creates a prop and is used by others).</p></li>
<li><p><strong>Finalized</strong>: Sticky props created/updated during the use of the context are synched back to the FLCM, so that FL
contexts created afterwards will contain these props.</p></li>
</ul>
</div></blockquote>
<p>Keep in mind that sticky props syncing only happens when the context is finalized, not at the moment that the prop is created.</p>
</div>
<div class="section" id="data-available-in-the-shared-flcontext">
<h2>Data available in the shared FLContext<a class="headerlink" href="#data-available-in-the-shared-flcontext" title="Permalink to this headline">¶</a></h2>
<p>The public <code class="docutils literal notranslate"><span class="pre">FLContext</span></code> data is sent to other parties along with the <code class="docutils literal notranslate"><span class="pre">Shareable</span></code> object.
It contains the following content:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Value</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FLContextKey.PEER_CONTEXT</p></td>
<td><p>A dictionary</p></td>
<td><p>Its peer’s <code class="docutils literal notranslate"><span class="pre">FLContext</span></code></p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For an FL server, its peer is an FL client.
For an FL client, its peer is an FL server.</p>
</div>
<p>If the role is FL server, the peer context contains the following content:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Key</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>FLContextKey.CLIENT_NAME</p></td>
<td><p>FL client’s name</p></td>
</tr>
<tr class="row-odd"><td><p>AppConstants.CURRENT_ROUND</p></td>
<td><p>current training round</p></td>
</tr>
<tr class="row-even"><td><p>AppConstants.NUM_STEPS_CURRENT_ROUND</p></td>
<td><p>number of steps advanced in the current round</p></td>
</tr>
</tbody>
</table>
<p>To retrieve the shared <code class="docutils literal notranslate"><span class="pre">FLContext</span></code> data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">shared_context</span> <span class="o">=</span> <span class="n">fl_ctx</span><span class="o">.</span><span class="n">get_prop</span><span class="p">(</span><span class="n">FLContextKey</span><span class="o">.</span><span class="n">PEER_CONTEXT</span><span class="p">)</span>
<span class="n">client_name</span> <span class="o">=</span> <span class="n">shared_context</span><span class="o">.</span><span class="n">get_prop</span><span class="p">(</span><span class="n">FLContextKey</span><span class="o">.</span><span class="n">CLIENT_NAME</span><span class="p">)</span>
<span class="n">current_round</span> <span class="o">=</span> <span class="n">shared_context</span><span class="o">.</span><span class="n">get_prop</span><span class="p">(</span><span class="n">AppConstants</span><span class="o">.</span><span class="n">CURRENT_ROUND</span><span class="p">)</span>
<span class="n">number_steps</span> <span class="o">=</span> <span class="n">shared_context</span><span class="o">.</span><span class="n">get_prop</span><span class="p">(</span><span class="n">AppConstants</span><span class="o">.</span><span class="n">NUM_STEPS_CURRENT_ROUND</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="client-side-fl-context">
<h2>Client Side FL Context<a class="headerlink" href="#client-side-fl-context" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>The client-side workflow is a simple loop of:</dt><dd><ul class="simple">
<li><p>Ask for the next task to do</p></li>
<li><p>Do the task</p></li>
<li><p>Submit task result</p></li>
</ul>
</dd>
<dt>In each iteration:</dt><dd><ul class="simple">
<li><p>A new FLContext instance is created to request the next task from the server.</p></li>
<li><p>When a new task assignment is received, the FL context is augmented with the “peer context” received from the server</p></li>
<li><dl class="simple">
<dt>Task related data is added to the FL context:</dt><dd><ul>
<li><p>Task Name (FLContextKey.TASK_NAME)</p></li>
<li><p>Task ID (FLContextKey.TASK_ID)</p></li>
<li><p>Task Data (FLContextKey.TASK_DATA)</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>If any task data filters are configured for this task, the filters are called with this context. Additional props
could be added by the filters.</p></li>
<li><p>The FL context is then used for the task execution, during which additional props may be added.</p></li>
<li><p>The task result (FLContextKey.TASK_RESULT) is added to the FL context.</p></li>
<li><p>If any task result filters are configured for this task, the filters are called with this context. Additional
props could be added by the filters.</p></li>
<li><p>This FL context is used to send task results to the Server. Public props in the context will be sent to the Server.</p></li>
<li><p>Finally, this context is finalized - sticky props (if any) are synced with the FLCM.</p></li>
</ul>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If any event is fired during the processing, this FLContext instance is also passed to all event handlers, which
could create additional props.</p>
</div>
<p>The following diagram shows the lifecycle of the FL context for each iteration.</p>
<img alt="../_images/FL_Context.png" src="../_images/FL_Context.png" style="height: 600px;" />
<p>In the Peer Context, following props from the Server are available:</p>
<blockquote>
<div><ul class="simple">
<li><p>Run Number: peer_ctx.get_run_number())</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="server-side-fl-context">
<h2>Server Side FL Context<a class="headerlink" href="#server-side-fl-context" title="Permalink to this headline">¶</a></h2>
<div class="section" id="task-request-processing">
<h3>Task Request Processing<a class="headerlink" href="#task-request-processing" title="Permalink to this headline">¶</a></h3>
<p>When processing the “ask for next task” request from the client, the Server creates a new FL Context. This context is
used for the task’s before_task_sent and after_task_sent callbacks, task data filters (if any), and any event handling
fired during the task request processing.</p>
<p>Note that this context contains the “peer context” of the client.</p>
<dl class="simple">
<dt>In the Peer Context, following props from the Client are available:</dt><dd><ul class="simple">
<li><p>Run Number: peer_ctx.get_run_number()</p></li>
<li><p>Client Name: peer_ctx.get_identity_name()</p></li>
<li><p>May have additional public props</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="task-result-processing">
<h3>Task Result Processing<a class="headerlink" href="#task-result-processing" title="Permalink to this headline">¶</a></h3>
<p>When processing the “submit task result” request from the client, the Server creates a new FL Context. This context is
used for the task’s result_received callback, task result filters (if any), and any event handling fired during the
task result processing.</p>
<p>Note that this context contains the “peer context” of the client.</p>
<dl class="simple">
<dt>In the Peer Context, following props from the Client are available:</dt><dd><ul class="simple">
<li><p>Run Number: peer_ctx.get_run_number()</p></li>
<li><p>Client Name: peer_ctx.get_identity_name()</p></li>
<li><p>Task ID: peer_ctx.get_prop(FLContextKey.TASK_ID)</p></li>
<li><p>Task Name: peer_ctx.get_prop(FLContextKey.TASK_NAME)</p></li>
<li><p>May have additional public props</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="task-done-processing">
<h3>Task Done Processing<a class="headerlink" href="#task-done-processing" title="Permalink to this headline">¶</a></h3>
<p>When a task is completed (done normally or timed out), the task’s task_done callback (if specified) is called. A new
FL Context is created at the task completion. This context is used for the task’s task_done callback, and any event
handling fired during the task completion processing.</p>
<p>Note that this context does not contain a peer context.</p>
</div>
<div class="section" id="controller-s-control-flow">
<h3>Controller’s Control Flow<a class="headerlink" href="#controller-s-control-flow" title="Permalink to this headline">¶</a></h3>
<p>The controller’s control_flow method is called at the beginning of the RUN. When the control_flow returns, the RUN is
completed.</p>
<p>At the beginning of the RUN, a new FL Context is created, and is used to call the control_flow method of the controller.
This context “lives” until the end of the control loop. This is a long-lived context. This context does not contain a
peer context.</p>
</div>
</div>
<div class="section" id="peer-context">
<h2>Peer Context<a class="headerlink" href="#peer-context" title="Permalink to this headline">¶</a></h2>
<p>As discussed above, any components can access a FLContext and get/set props from/into it. This allows components running
within the same process to share data.</p>
<p>The data sharing is not limited to components within the same process (Server or Client). Data props can be shared
between communicating peers! This is done through what is called “peer context”:</p>
<blockquote>
<div><ul class="simple">
<li><p>When the client sends the “ask for next task” request, public props in the client’s FLContext are also sent to the
Server.</p></li>
<li><p>When the Server receives the request and the props from the client, the Server first prepares a new FLContext
object X for the request processing, creates another FLContext object to hold the props from the client and sets
this FLContext object into X.</p></li>
<li><p>All the processing logic has access to X, and can therefore access the peer context via x.get_peer_context() call.</p></li>
<li><p>Similarly, during the processing, any involved component can add public props to X, and all such props will be
sent back to the Client, which will become content of the “peer context” on the Client side.</p></li>
</ul>
</div></blockquote>
<p>What is in the peer context? It depends on what public props are in the FLContext before being sent to the peer. But in
general, the following props are always available:</p>
<blockquote>
<div><ul class="simple">
<li><p>Run Number (fl_ctx.get_run_number()). This is the ID number of the RUN on the peer site. Note that the peer’s RUN
number may be different from the host site’s RUN number in case the two sites get out of sync.</p></li>
<li><p>Identity Name (fl_ctx.get_identity_name()). This is the unique name of the peer site (client name or server name).</p></li>
</ul>
</div></blockquote>
<p>Additional props are available from the peer context, depending on the communication scenarios.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Peer context should be treated as read-only.</p>
</div>
</div>
<div class="section" id="create-ad-hoc-fl-context">
<h2>Create ad-hoc FL Context<a class="headerlink" href="#create-ad-hoc-fl-context" title="Permalink to this headline">¶</a></h2>
<p>All the contexts discussed above are created and managed by the NVIDIA FLARE framework. They should meet most of your
needs. However, you can create ad-hoc contexts in your program if necessary. To be thread safe, you should create a new
FLContext instance for each thread - threads should not share the same FLContext object. To create a FLContext object,
do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ctx</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">new_context</span><span class="p">()</span>
</pre></div>
</div>
<p>As a best practice, when using the context you created, you should use a “with” block so that any sticky props created
in your processing logic will be synced back to the FLCM when the “with” block exits:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">ctx</span><span class="p">:</span>
    <span class="n">processing</span> <span class="n">logic</span>
</pre></div>
</div>
</div>
<div class="section" id="api-specification">
<h2>API Specification<a class="headerlink" href="#api-specification" title="Permalink to this headline">¶</a></h2>
<div class="section" id="property-access">
<h3>Property access<a class="headerlink" href="#property-access" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">set_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sticky</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">set_prop</span></code>, you can set any object to the context by providing a key and the value of the object.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">private</span></code> is set to True, this property can only be used locally.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">private</span></code> is set to False, this property can be shared to its peer during the FL communication.</p>
<p>In other words, when an FL client is communicating with other clients, the non-private properties in the FLContext
will be sent to those clients.</p>
<p>There are many predefined keys used by different <code class="docutils literal notranslate"><span class="pre">FLComponent</span></code> functions. If you want to use the components that
NVIDIA FLARE provide, please refer to <a class="reference internal" href="#data-available-in-the-shared-flcontext">Data available in the shared FLContext</a> and <a class="reference internal" href="../apidocs/nvflare.apis.html#module-nvflare.apis.fl_constant" title="nvflare.apis.fl_constant"><code class="xref py py-mod docutils literal notranslate"><span class="pre">nvflare.apis.fl_constant</span></code></a> for
details. Otherwise, you can write your own components by extending <code class="docutils literal notranslate"><span class="pre">FLComponent</span></code>.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="filters.html" class="btn btn-neutral float-right" title="Filters" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="event_system.html" class="btn btn-neutral float-left" title="NVIDIA FLARE Event Mechanism" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, NVIDIA.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  p {
    margin-bottom: 1em;
  }

  .rst-content dl dt {
    font-weight: unset;
    margin-bottom: 0;
  }

  .rst-content .section ul p {
    margin-bottom: 0px;
  }
  </style>
  

</body>
</html>